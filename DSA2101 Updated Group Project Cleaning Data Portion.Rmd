---
title: "DSA2101 Group Project"
author: "World Cup Finals Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The FIFA World Cup Dataset covers every single World Cup match played in its history from Uruguay in 1930 to Russia in 2018. The dataset consists of two `csv` files: `wcmatches.csv` and `worldcups.csv`.

1. The `wcmatches.csv` file contains every football match played in the World Cup, with some columns like which year, which team claimed victory, and what the win condition was.

2. The `worldcups.csv` file contains the winners and has some dataset features like winners, games, goals_scored and more.

We load the libraries to be used here:
```{r libraries, warning = FALSE, message = FALSE}
library(readr)
library(tidyverse)
library(stringr)
library(ggplot2)
library(forcats)
library(maps)
library(ggthemes)
```

# Data cleaning and summary

Firstly, we read in the two datasets using the `readr` package.

```{r Reading Data, warning = FALSE, message = FALSE}
wcmatches <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/wcmatches.csv')
worldcups <- readr::read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-11-29/worldcups.csv')
```

After that, we did some cleaning with the two datasets. 

In data preparation for the `worldcups` dataset, we restructured it by pivoting the data longer, condensing the `winner` columns to `fourth` columns to create a cleaner `position_status` column. We also standardised `USA` to `United States`, and introduced a new `continent` feature for future visualization, splitting into three groups: North and South America (`americas`), Europe (`europe`) and the rest of the world (`others`).

```{r Data Cleaning 1}
americas <- c("Uruguay", "Brazil", "Chile", "Mexico", "Argentina", "United States")

europe <- c("Italy", "France", "Switzerland", "Sweden", "England", "Germany", "Spain", "West Germany", "Netherlands", "Austria", "Belgium", "Croatia", "Czechoslovakia", "Hungary", "Poland", "Portugal", "Yugoslavia", "Bulgaria", "Soviet Union", "Turkey", "Russia")

others <- c("South Africa", "Japan", "South Korea", "Japan, South Korea")

worldcups_tidy <- worldcups %>%
                  pivot_longer(winner:fourth, names_to = "position_status", values_to = "country_name") %>%
                  rename(host_country = host) %>%
                  mutate(host_country = ifelse(host_country == "USA", "United States", host_country), 
                         country_name = ifelse(country_name == "USA", "United States", country_name)) %>%
                  mutate(host_continent = case_when(
                         host_country %in% americas ~ "Americas", 
                         host_country %in% europe ~ "Europe",
                         host_country %in% others ~ "Rest Of World"), 
                         country_continent = case_when(
                         country_name %in% americas ~ "Americas", 
                         country_name %in% europe ~ "Europe",
                         country_name %in% others ~ "Rest Of World"))
```

For the `wcmatches` dataset, columns were renamed, clarifying `stage_status` from `stage` and `win_outcome` from `outcome`. We refined the `stage_status` further, converting `Group` to `Group Stage` and `Final Round` to `Finals` for clarity. Redundant date information was removed, and the `win_outcome` column was expanded for clear representation of `H` (Home Win), `D` (Draw), and `A` (Away Win). We calculated the score difference, filled the `win_conditions` column with `Nil`, and extracted two features, `after_extra_time` and `penalties`.

```{r Data Cleaning 2}
wcmatches_tidy <- wcmatches %>%
                  rename(stage_status = stage, win_outcome = outcome) %>%
                  mutate(stage_status = ifelse(str_detect(stage_status, "Group"), "Group Stage", stage_status), 
                         stage_status = ifelse(stage_status == "Final Round", "Final", stage_status)) %>%
                  select(-date) %>%
                  mutate(win_outcome = case_when(
                         home_score == away_score ~ "Draw",
                         win_outcome == "H" ~ "Home",
                         win_outcome == "D" ~ "Draw",
                         win_outcome == "A" ~ "Away")) %>%
                  mutate(score_difference = abs(home_score - away_score), 
                         win_conditions = replace_na(win_conditions, "Nil"),
                         after_extra_time = ifelse(str_detect(win_conditions, "AET"), 1, 0), 
                         penalties = ifelse(str_detect(win_conditions, "penalties"), 1, 0)) 
```

These are all in preparation to answer the question: **Is the host country advantageous during the World Cup?**

To answer our question, we prepared three visualisations: a heatmap, a scatterplot and a line plot.

# Visualisations

## Visualisation 1: Heatmap

We want to create a heatmap showcasing the total points across all World Cup matches for every country. We will split this process into two parts:
1. Preparing the data to tabulate the all-time total points for each country.
2. Plotting the points on the heatmap

### Part 1: Preparing the Data

As per FIFA convention, for each match, we award 3 points to the winning team, 0 points to the losing team and 1 point to both teams if it ends in a draw.

- Group Stage matches before the 1994 World Cup awarded 2 points for a win instead of 3 (FIFA, 2016). However, for simplicity and standardisation, we will award 3 points for a win regardless of the year.

- For knockout stage matches where one team wins in extra time, we award 3 points to the winning team and 0 points to the losing team.

- For knockout stage matches that end in penalty shootouts, we award 1 point to both teams as we consider it a draw. The outcome of the penalty shootout does not affect the points.

In the case of our dataset, we considered the following cases in point allocation:

- Case 1: If `home_score` > `away_score`, `home_team` gets 3 points, `away_team` gets 0 points. 
  
- Case 2: If `away_score` > `home_score`, `away_team` gets 3 points, `home_team` gets 0 points.
  
- Case 3: If `home_score` = `away_score`, the match is a draw. Both teams given 1 point each.
  
Note: `after_extra_time` does not affect the victory/loss of the teams. Matches that require penalties are considered a draw.

Firstly, we ensure that all matches ending with penalties have a `win_outcome` of `Draw`. Afterwards, select the relevant columns: `home_team`, `away_team` and `win_outcome` to tidy the dataset further. We store this in a new dataset called `wcmatches_updated`.

```{r Heatmap 1a}
wcmatches_updated <- wcmatches_tidy %>%
                     mutate(win_outcome = ifelse(penalties == 1, "Draw", win_outcome)) %>%
                     select(home_team, away_team, win_outcome)
```

Next, we filter the `wcmatches_updated` dataset for observations where either the home or away team wins. We only keep the teams that win each match. We count the frequency of each team in the dataset and multiply this value by 3 to get the `win_points`. We store this in a dataset called `wcmatches_wins`.

```{r Heatmap 1b}
wcmatches_wins <- wcmatches_updated %>%
                  filter(win_outcome %in% c("Home", "Away")) %>%
                  mutate(country = ifelse(win_outcome == "Home", home_team, away_team)) %>%
                  select(country) %>%
                  group_by(country) %>%
                  summarise(win_points = 3 * n())
```

We do the same for matches that end in a draw. We keep both the home and away teams and combine them in a single column. We count the frequency of each team in the dataset to get the `draw_points`, as a draw gives 1 point to both teams. We store this in a dataset called `wcmatches_draws`.

```{r Heatmap 1c}
wcmatches_draws <- wcmatches_updated %>%
                   filter(win_outcome == "Draw") %>%
                   pivot_longer(home_team:away_team) %>%
                   rename(country = value) %>%
                   select(country) %>%
                   group_by(country) %>%
                   summarise(draw_points = n())
```

We also included countries that participated in the World Cup at least once but did not score any points over the years.

```{r Heatmap 1d}
home_countries <- wcmatches_tidy %>%
                  select(home_team) %>%
                  distinct() %>%
                  rename(country = home_team)

away_countries <- wcmatches_tidy %>%
                  select(away_team) %>%
                  distinct() %>%
                  rename(country = away_team)

wcmatches_allcountries <- rbind(home_countries, away_countries) %>%
                          distinct()
```

Afterwards, we do a full join of `wcmatches_wins`, `wcmatches_draws` and `wcmatches_allcountries` to ensure all teams that ever participated in the World Cup are included in the merged dataset. Some entries in the merged dataset contain `NA` values as some countries are not in either `wcmatches_draws` or `wcmatches_wins`. We replace these `NA` values with `0` and compute the total points for each country by adding the `draw_points` and `win_points`.

Some former teams like the Soviet Union and Yugoslavia were renamed to their present-day countries in order to merge with `map_data("world")` from the `maps` package. For East Germany, we consider it to be part of the present-day Germany although FIFA does not count their records as part of present-day Germany. We then stored it in a new dataset called `wcmatches_tabulated`.

```{r Heatmap 1e}
wcmatches_tabulated <- wcmatches_wins %>%
                       full_join(wcmatches_draws, by = "country") %>%
                       full_join(wcmatches_allcountries, by = "country") %>%
                       mutate(win_points = replace_na(win_points, 0),
                              draw_points = replace_na(draw_points, 0),
                              total_points = win_points + draw_points) %>% 
                       select(country, total_points) %>%
                       mutate(country = case_when(
                         country == "West Germany" ~ "Germany",
                         country == "East Germany" ~ "Germany",
                         country == "Soviet Union" ~ "Russia",
                         country == "Yugoslavia" ~ "Serbia",
                         country == "FR Yugoslavia" ~ "Serbia",
                         country == "Czechoslovakia" ~ "Czech Republic",
                         country == "Dutch West Indies" ~ "Indonesia",
                         country == "Zaire" ~ "Democratic Republic of the Congo",
                         .default = country)) %>%
                       group_by(country) %>%
                       summarise(total_points = sum(total_points))
```


### Part 2: Visualising `total_points` on a heatmap

We now visualise the total points obtained on a heatmap by using `map_data("world")` to get the world coordinates. We renamed some countries to match those in the `wcmatches_tabulated` dataset. For example, the United Kingdom consisting of Scotland, Great Britain, Isle of Wight, Wales and Northern Ireland should be separated into their subregions.

```{r Heatmap 2a}
world_map <- map_data("world") %>%
             mutate(region = case_when(
               region == "USA" ~ "United States",
               region == "China" ~ "China PR",
               region == "Ireland" ~ "Republic of Ireland",
               subregion == "Scotland" ~ "Scotland",
               subregion == "Great Britain" ~ "England",
               subregion == "Isle of Wight" ~ "England",
               subregion == "Wales" ~ "Wales",
               subregion == "Northern Ireland" ~ "Northern Ireland",
               .default = region)) %>%
             select(-subregion)
```

Next, we do a full join on the `world_map` dataset with the `wcmatches_tabulated` dataset, as we want to include countries that never participated in the World Cup in our map. All countries in `wcmatches_tabulated` exist in the `region` column of the `world_map` dataset.

```{r Heatmap 2b}
top_countries_joined <- wcmatches_tabulated %>%
                        full_join(world_map, by = c("country" = "region"))
```

Lastly, we use `ggplot` to generate a heatmap showcasing the total points each country obtained from World Cup matches over the years. Countries that never participated in the World Cup have a score of `NA` in the `top_countries_joined` dataset and are coloured white in the heatmap.

```{r Heatmap 2c}
ggplot(top_countries_joined, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_points)) +
  labs(title = "Global Distribution of Total Points obtained across World Cups (1930-2018)") +
  scale_fill_gradientn(name = "Total Points",
                       colors = c("#ffffb2", "#fecc5c", "#fd8d3c", "#f03b20", "#bd0026"),
                       na.value = "white") +
  borders(colour = "black", size = 0.1) +
  theme_minimal() +
  theme(legend.position = "bottom", axis.title = element_blank(), axis.text = element_blank(),
        panel.grid = element_blank(), plot.title = element_text(hjust = 0.5)) +
  ylim(-60, 90)
```


## Visualisation 2: Scatter Plot

Host country performance: Avg number of wins when they are not the host vs when they are the host 
```{r Scatter}

```


## Visualisation 3: Line Plot

For the last line plot, we want to see whether the stage status has affected the goal differences.

We do this by finding the **proportion of goals that a host country has scored during their run**.
(For example, in 1950, Brazil scored 25% of the total goals because they scored 22 goals in total, out of the 88 goals scored throughout the tournament.)

For this visualisation in particular, we will want to combine both "Final" and "Third Place" as "Final Matches". This is because it is meaningless to visualise both the Final match and the Third Place match if we're looking to find the average. 

```{r Line Plot}
viz_3_wcmatches <- wcmatches_tidy %>% 
  filter(home_team == country) %>%
  select(year, home_score) %>%
  group_by(year) %>%
  summarize(total_goals_scored = sum(home_score))

viz_3_worldcups <- worldcups_tidy %>%
  rename(country = host_country) %>%
  group_by(year, country) %>% 
  summarize(goals_scored = mean(goals_scored)) %>% 
  select(year, country, goals_scored)

viz_3_data <- viz_3_wcmatches %>%
  left_join(viz_3_worldcups, by = "year") %>%
  mutate(goal_proportion = (total_goals_scored / goals_scored) * 100) %>%
  select(year, country, goal_proportion)

ggplot(data = viz_3_data, aes(x = year, y = goal_proportion)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_x_continuous(breaks = seq(1930, 2018, 8)) +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) +
  labs(title = "Proportion of Goals scored by Host Countries (1930-2018)",
       subtitle = "Goals scored by host country as a percentage of total goals scored",
       x = "Year", y = "Proportion of Goals Scored") +
  theme(plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5))

```

``` {r}
wcmatches_tidy
```

``` {r}
worldcups_tidy
```

# Discussion
From the guidelines (1-2 paragraphs): Describe the primary insights you aim to convey through your visualizations. Explore and explain why the data appears the way it does.

Something about host country's performance


# References
- R for Data Science Community. (2022, November 29). TidyTuesday Week 48, 2022. GitHub. https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-11-29
- USA ’94: A World Cup of firsts. (2016, May 4). FIFA Museum. https://www.fifamuseum.com/en/blog-stories/blog/usa-94-a-15th-world-cup-full-of-firsts-2610677/

