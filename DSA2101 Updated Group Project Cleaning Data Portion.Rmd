---
title: "Group Project Preparation"
author: "World Cup Finals Group"
date: "`r Sys.Date()`"
output: html_document
---

## World Cup Dataset 

### Introduction

The FIFA World Cup Dataset covers every single World Cup match played in its history from Uruguay in 1930 to Russia in 2018. The dataset consists of two spreadsheets. The `wcmatches.csv` file contains every football match played in the World Cup, with some columns like which year, which team claimed victory, and what the win condition was. The `worldcups.csv` file contains the winners and has some dataset features like winners, games, goals_scored and more.

### Data cleaning and summary

Firstly, we prepare the two datasets using the `readr` package.

```{r Reading Data}
library(readr)

# we read from tidytuesday
root_url <- 'https://raw.githubusercontent.com/'
intermediate <- 'rfordatascience/tidytuesday/master/data/2022/2022-11-29/'

wcmatches <- read_csv(paste0(root_url, intermediate, 'wcmatches.csv'))
worldcups <- read_csv(paste0(root_url, intermediate, 'worldcups.csv'))
```

After that, we will do some cleaning with the two datasets. 

In data preparation for the worldcups dataset, we restructured it by pivoting the data longer, condensing the "winner" columns to "fourth" columns to create a cleaner "position_status" column. We also standardised "USA" to "United States," and introduced a new "continent" feature for future visualization.

For the wcmatches dataset, columns were renamed, clarifying "stage_status" from "stage" and "win_outcome" from "outcome." We refined the "stage_status" further, converting "Group" to "Group Stage" and "Final Round" to "Finals" for clarity. Redundant date information was removed, and the "win_outcome" column was expanded for clear representation of "H" (Home Win), "D" (Draw), and "A" (Away Win). We calculated the score difference, filled the "win_conditions" column with "Nil," and extracted two features, "after_extra_time" and "penalties."

These are all in preparation to answer the question - what factors affect the performance of countries in the World Cup?

```{r Data Cleaning}
library(tidyverse)
library(stringr)

# American countries within the datasets 
americas <- c("Uruguay", "Brazil", "Chile", "Mexico", "Argentina", "United States")

europe <- c("Italy", "France", "Switzerland", "Sweden", "England", "Germany", "Spain", "West Germany", "Netherlands", "Austria", "Belgium", "Croatia", "Czechoslovakia", "Hungary", "Poland", "Portugal", "Yugoslavia", "Bulgaria", "Soviet Union", "Turkey", "Russia")

others <- c("South Africa", "Japan", "South Korea", "Japan, South Korea")

worldcups_tidy <- worldcups %>%
                  pivot_longer(winner:fourth, names_to = "position_status", values_to = "country_name") %>%
                  rename(host_country = host) %>%
                  mutate(host_country = ifelse(host_country == "USA", "United States", host_country), 
                         country_name = ifelse(country_name == "USA", "United States", country_name)) %>% mutate(host_continent = case_when(
                         host_country %in% americas ~ "Americas", 
                         host_country %in% europe ~ "Europe",
                         host_country %in%  others ~ "Rest Of World"), 
                         country_continent = case_when(
                         country_name %in% americas ~ "Americas", 
                         country_name %in% europe ~ "Europe",
                         country_name %in%  others ~ "Rest Of World")) 

wcmatches_tidy <- wcmatches %>%
                  rename(stage_status = stage, win_outcome = outcome) %>%
                  mutate(stage_status = ifelse(str_detect(stage_status, "Group"), "Group Stage", stage_status), 
                         stage_status = ifelse(stage_status == "Final Round", "Finals", stage_status)) %>%
                  select(-date) %>%
                  mutate(win_outcome = case_when(
                         home_score == away_score ~ "Draw",
                         win_outcome == "H" ~ "Home",
                         win_outcome == "D" ~ "Draw",
                         win_outcome == "A" ~ "Away")) %>%
                  mutate(score_difference = abs(home_score - away_score), 
                         win_conditions = replace_na(win_conditions, "Nil"),
                         after_extra_time = ifelse(str_detect(win_conditions, "AET"), 1, 0), 
                         penalties = ifelse(str_detect(win_conditions, "penalties"), 1, 0)) 
```

### Visualisations 

1st Visualization: 

**Create a bar plot showcasing the top ten countries in the world cup that have the highest total points for all years**

Point Allocation Should be: 

  Case 1: If Home Score > Away Score, Home Team given 3 points, Away Team given 0 points. 
  
  Case 2: If Away Score > Home Score, Away Team given 3 points, Home Team given 0 points.
  
  Case 3: If Home Score = Away Score, match is a draw, 1 point will be allocated to both teams. 
  
Note: `after_extra_time` does not affect the victory/loss of the teams. Matches that require penalties are considered draw.
  
```{r}
library(ggplot2)
library(forcats)

# Firstly, ensure that all the rows of the `wcmatches_tidy` dataset where penalties are required are set to Draw in the `win_outcome` column of the dataset. Afterwards, select the relevant columns: `home_team`, `away_team` and `win_outcome` to tidy the dataset further. This is stored in a new dataset called `wcmatches_updated`. 

wcmatches_updated <- wcmatches_tidy %>%
                     mutate(win_outcome = ifelse(penalties == 1, "Draw", win_outcome)) %>%
                     select(home_team, away_team, win_outcome)

# Next, subset the `wcmatches_updated` dataset to filter for observations that either the home team or the away team wins. The teams that win the matches are to be kept. Count the number of times each team is present in the dataset and subsequently, multiply the count of each team by 3 to get the win points. Store this in a dataset called `wcmatches_wins`.

wcmatches_wins <- wcmatches_updated %>%
                  filter(win_outcome %in% c("Home", "Away")) %>%
                  mutate(country = ifelse(win_outcome == "Home", home_team, away_team)) %>%
                  select(country) %>%
                  group_by(country) %>%
                  summarise(win_points = 3 * n())

# Similarly, subset the `wcmatches_updated` dataset to filter for observations where the matches have a draw result. Both the home team and the away team are to be kept. Combine the home and away teams in a single column and count the number of times each team is present in the dataset. Draw points is equal to the count. Store this in a dataset called `wcmatches_draws`.

wcmatches_draws <- wcmatches_updated %>%
                   filter(win_outcome == "Draw") %>%
                   pivot_longer(home_team:away_team) %>%
                   rename(country = value) %>%
                   select(country) %>%
                   group_by(country) %>%
                   summarise(draw_points = n())

# Afterwards, join `wcmatches_wins` and `wcmatches_draws` and ensure that all teams are contained in the merged dataset. Certain entries in the merged dataset contain NA values as some countries are not found in either `wcmatches_draws` or `wcmatches_wins`. The NA values should be replaced by 0. Compute the total points for each country by summing the draw points and win points. Store it in a new dataset called `wcmatches_tabulated`. 

wcmatches_tabulated <- wcmatches_wins %>%
                       full_join(wcmatches_draws, by = "country") %>%
                       mutate(win_points = replace_na(win_points, 0),
                              draw_points = replace_na(draw_points, 0),
                              total_points = win_points + draw_points) %>% 
                       select(country, total_points) %>%
                       arrange(desc(total_points)) %>%
                       head(10)

# Lastly, use ggplot to generate the bar plot that showcase the top 10 countries that have the highest number of total points arranged in descending order in a horizontal format. Rename the labels accordingly. 

ggplot(wcmatches_tabulated, aes(x = fct_reorder(country, total_points), y = total_points)) + 
  geom_col(fill = "#FF9999") +
  coord_flip() + 
  labs(x = "Country", y = "Total Points", title = "Top 10 Best Performing Countries In World Cup") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  geom_text(label = wcmatches_tabulated$total_points, size = 5, position = position_stack(vjust = 0.5))
```

# Alternative: heat map
```{r}
library(maps)

world_coordinates = map_data("world") %>%
                    mutate(region = case_when(
                           region == "USA" ~ "United States",
                           subregion == "Scotland" ~ "Scotland",
                           subregion == "Great Britain" ~ "England",
                           subregion == "Isle of Wight" ~ "England",
                           subregion == "Wales" ~ "Wales",
                           subregion == "Northern Ireland" ~ "Northern Ireland",
                           .default = region)) %>%
                    select(-subregion)

wcmatches_tabulated_two <- wcmatches_wins %>%
                           full_join(wcmatches_draws, by = "country") %>%
                           mutate(win_points = replace_na(win_points, 0),
                                  draw_points = replace_na(draw_points, 0),
                                  total_points = win_points + draw_points) %>% 
                           select(country, total_points) %>% 
                           mutate(country = case_when(
                                  country == "West Germany" ~ "Germany",
                                  country == "East Germany" ~ "Germany",
                                  country == "Soviet Union" ~ "Russia",
                                  country == "Yugoslavia" ~ "Serbia",
                                  country == "FR Yugoslavia" ~ "Serbia",
                                  country == "Czechoslovakia" ~ "Czech Republic",
                                  .default = country)) %>%
                           group_by(country) %>%
                           summarise(total_points = sum(total_points))

top_countries_joined = world_coordinates %>%
                       left_join(wcmatches_tabulated_two, by = c("region" = "country"))

ggplot(data = top_countries_joined, mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_points)) +
  scale_fill_distiller(palette = "Spectral", direction = -1, name = "Total Points") +
  theme(
    axis.text = element_blank(),
    axis.line = element_blank(),
    axis.ticks = element_blank(),
    panel.border = element_blank(),
    panel.grid = element_blank(),
    axis.title = element_blank(),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(hjust = 0.5)) +
  labs(title = "Global Distribution of Total Points obtained across World Cups")

```




Performance based on rankings in each world cup (work in progress, I need to think of a good way to do this)
- average ranking across all world cups attended?
- categories (winner, 2nd, 3rd, 4th, top8, top16, group stage)?
```{r}

```

Host country performance
```{r}

```



### DO NOT DELETE THIS
1. find country with best overall performance --> hypothesize with the next few questions
2. line plot
3. scatterplot 
