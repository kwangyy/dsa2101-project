---
title: "DSA2101 Group Project"
author: "World Cup Finals Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The FIFA World Cup Dataset covers every single World Cup match played in its history from Uruguay in 1930 to Russia in 2018. The dataset consists of two `csv` files: `wcmatches.csv` and `worldcups.csv`.

1. The `wcmatches.csv` file contains every football match played in the World Cup, with some columns like which year, which team claimed victory, and what the win condition was.

2. The `worldcups.csv` file contains the winners and has some dataset features like winners, games, goals_scored and more.

We load the libraries to be used here:
```{r libraries, warning = FALSE, message = FALSE}
library(tidytuesdayR)
library(readr)
library(tidyverse)
library(stringr)
library(ggplot2)
library(forcats)
library(maps)
library(ggthemes)
```

# Data cleaning and summary

Firstly, we read in the two datasets using the `readr` package.

```{r Reading Data, warning = FALSE, message = FALSE}
tuesdata <- tidytuesdayR::tt_load('2022-11-29')
wcmatches <- tuesdata$wcmatches
worldcups <- tuesdata$worldcups

wcmatches
```

After that, we performed data cleaning on both datasets. We start with the`worldcups` dataset by using the pivot_longer function to consolidate the columns from `winner` to `fourth` into the `position_status` column. We standardized "USA" to "United States" and introduced a new `continent` feature, categorizing countries into three groups: North and South America (americas), Europe (europe), and the rest of the world (others) for future visualization. For the wcmatches dataset, we refined column names from `stage` to `stage_status` and `outcome` to `win_outcome`. We realised that `stage_status` did not have consistent values amongst the Group Stage and Finals, and converted `Group` to `Group Stage` and  `Final Round` to `Final` for consistency. We removed the `date` column, and cleaned up the columns denoting the wins by expanding the `win_outcome` column to represent Home, Draw and Away and filled missing values in `win_conditions` with `Nil`. Lastly, we featured engineer the score difference as well as the win conditions, creating two new features `after_extra_time` and `penalties`.

```{r Data Cleaning 1}
# Code block for the worldcups dataset

# Define different continents
americas <- c("Uruguay", "Brazil", "Chile", "Mexico", "Argentina", "United States")

europe <- c("Italy", "France", "Switzerland", "Sweden", "England", "Germany", "Spain", "West Germany", "Netherlands", "Austria", "Belgium", "Croatia", "Czechoslovakia", "Hungary", "Poland", "Portugal", "Yugoslavia", "Bulgaria", "Soviet Union", "Turkey", "Russia")

others <- c("South Africa", "Japan", "South Korea", "Japan, South Korea")

# Transform the 'worldcups' data frame using pivot_longer
worldcups_tidy <- worldcups %>%
  pivot_longer(winner:fourth, names_to = "position_status", values_to = "country_name") %>%
  
  # Rename columns for clarity
  rename(host_country = host) %>%
  
  # Standardize country names for the host and participating countries
  mutate(
    host_country = ifelse(host_country == "USA", "United States", host_country), 
    country_name = ifelse(country_name == "USA", "United States", country_name)
  ) %>%
  
  # Create new columns for host and country continents
  mutate(
    host_continent = case_when(
      host_country %in% americas ~ "Americas", 
      host_country %in% europe ~ "Europe",
      host_country %in% others ~ "Rest Of World"
    ), 
    country_continent = case_when(
      country_name %in% americas ~ "Americas", 
      country_name %in% europe ~ "Europe",
      country_name %in% others ~ "Rest Of World"
    )
  )
```


```{r Data Cleaning 2}
# Code block for the wcmatches dataset 

# Rename columns for clarity
wcmatches_tidy <- wcmatches %>%
  rename(stage_status = stage, win_outcome = outcome) %>%
  
  # Standardize values in the 'stage_status' column
  mutate(
    stage_status = ifelse(str_detect(stage_status, "Group"), "Group Stage", stage_status), 
    stage_status = ifelse(stage_status == "Final Round", "Final", stage_status)
  ) %>%
  
  # Remove the 'date' column
  select(-date) %>%
  
  # Categorize win outcomes for clear representation
  mutate(
    win_outcome = case_when(
      home_score == away_score ~ "Draw",
      win_outcome == "H" ~ "Home",
      win_outcome == "D" ~ "Draw",
      win_outcome == "A" ~ "Away"
    )
  ) %>%
  
  # Feature engineering: Calculate score difference and handle missing values
  mutate(
    score_difference = abs(home_score - away_score), 
    win_conditions = replace_na(win_conditions, "Nil"),
    
    # Create binary features based on win conditions
    after_extra_time = ifelse(str_detect(win_conditions, "AET"), 1, 0), 
    penalties = ifelse(str_detect(win_conditions, "penalties"), 1, 0)
  )
```

There are a few interesting statistics that we have found out with the datasets:

1. The years 1942 and 1946 are not included in the dataset. Upon further research, we realise that there are no world cup matches held in 1942 and 1946 due to the second world war. This leads to a larger year difference of 12 years between the 1938 and the 1950 world cup matches, which will be reflected in some of our plots. 

2. The years 1934 and 1950 had a very different system on how the world cup was held, unlike traditional world cups. A traditional world cup often consists of the group stages, round of 16, quarter finals, semifinals and finals. Typically, the stages after the group stages were played in a knockout format, i.e. the winning team would continue, while the losing team was out. However, for 1934, there was the lack of group stages while for 1950, the stages after the group stages were considered "Finals" and played just like group stages instead of the aforementioned knockout format. 

``` {r Statistic 1}
# The years where the World Cup is supposed to be held on
supposed_years <- seq(1930, 2018, by = 4)

# The years where the World Cup is actually held on, for visualization purposes
actual_years <- wcmatches_tidy %>% 
  select(year) %>% 
  distinct()

# Find years that do not exist in actual_years
missing_years <- supposed_years[!(supposed_years %in% actual_years$year)]
```

``` {r Statistic 2}
stages_1934 <- wcmatches_tidy %>% 
  filter(year == 1934) %>%
  select(stage_status) %>%
  distinct()


stages_1950 <- wcmatches_tidy %>% 
  filter(year == 1950) %>%
  select(stage_status) %>%
  distinct()

stages_1934
stages_1950
```
These are all in preparation to answer the question: **Is the host country advantageous during the World Cup?**

To answer our question, we prepared three visualisations: a heatmap, a scatterplot and a line plot.

# Visualisations

## Visualisation 1: Heatmap

We want to create a heatmap showcasing the total points across all World Cup matches for every country. We will split this process into two parts:
1. Preparing the data to tabulate the all-time total points for each country.
2. Plotting the points on the heatmap

### Part 1: Preparing the Data

As per FIFA convention, for each match, we award 3 points to the winning team, 0 points to the losing team and 1 point to both teams if it ends in a draw. There are some exceptions and here's how we rectified them:
- Group Stage matches before the 1994 World Cup awarded 2 points for a win instead of 3 (FIFA, 2016). However, for simplicity and standardisation, we will award 3 points for a win regardless of the year.

- For knockout stage matches where one team wins in extra time, we award 3 points to the winning team and 0 points to the losing team.

- For knockout stage matches that end in penalty shootouts, we award 1 point to both teams as we consider it a draw. The outcome of the penalty shootout does not affect the points.
  
- `after_extra_time` does not affect the victory/loss of the teams. Matches that require penalties are considered a draw.

Firstly, we ensure that all matches ending with penalties have a `win_outcome` of `Draw`. Afterwards, select the relevant columns: `home_team`, `away_team` and `win_outcome` to tidy the dataset further. We store this in a new dataset called `wcmatches_updated`.
Next, we filter the `wcmatches_updated` dataset for observations where either the home or away team wins. We only keep the teams that win each match. We count the frequency of each team in the dataset and multiply this value by 3 to get the `win_points`. We store this in a dataset called `wcmatches_wins`. We do the same for matches that end in a draw. We keep both the home and away teams and combine them in a single column. We count the frequency of each team in the dataset to get the `draw_points`, as a draw gives 1 point to both teams. We store this in a dataset called `wcmatches_draws`. 
We also included countries that participated in the World Cup at least once but did not score any points over the years.

Afterwards, we do a full join of `wcmatches_wins`, `wcmatches_draws` and `wcmatches_allcountries` to ensure all teams that ever participated in the World Cup are included in the merged dataset. Some entries in the merged dataset contain `NA` values as some countries are not in either `wcmatches_draws` or `wcmatches_wins`. We replace these `NA` values with `0` and compute the total points for each country by adding the `draw_points` and `win_points`.

Some former teams like the Soviet Union and Yugoslavia were renamed to their present-day countries in order to merge with `map_data("world")` from the `maps` package. For East Germany, we consider it to be part of the present-day Germany although FIFA does not count their records as part of present-day Germany. We then stored it in a new dataset called `wcmatches_tabulated`.

```{r Qn 1a Preparation}
# Update win_outcome
wcmatches_updated <- wcmatches_tidy %>%
  mutate(win_outcome = ifelse(penalties == 1, "Draw", win_outcome)) %>%
  select(home_team, away_team, win_outcome)

# Calculate win points
wcmatches_wins <- wcmatches_updated %>%
  filter(win_outcome %in% c("Home", "Away")) %>%
  group_by(country = case_when(win_outcome == "Home" ~ home_team, win_outcome == "Away" ~ away_team)) %>%
  summarise(win_points = 3 * n())

# Calculate draw points
wcmatches_draws <- wcmatches_updated %>%
  filter(win_outcome == "Draw") %>%
  pivot_longer(home_team:away_team) %>%
  rename(country = value) %>%
  select(country) %>%
  group_by(country) %>%
  summarise(draw_points = n())

# Get unique home and away countries
wcmatches_allcountries <- wcmatches_tidy %>%
  select(home_team) %>%
  distinct() %>%
  rename(country = home_team) %>%
  bind_rows(wcmatches_tidy %>%
              select(away_team) %>%
              distinct() %>%
              rename(country = away_team)) %>%
  distinct()

# Tabulate the world cup matches
wcmatches_tabulated <- wcmatches_wins %>%
  full_join(wcmatches_draws, by = "country") %>%
  full_join(wcmatches_allcountries, by = "country") %>%
  mutate(
    win_points = replace_na(win_points, 0),
    draw_points = replace_na(draw_points, 0),
    total_points = win_points + draw_points,
    country = case_when(
      country %in% c("West Germany", "East Germany") ~ "Germany",
      country %in% c("Soviet Union") ~ "Russia",
      country %in% c("Yugoslavia", "FR Yugoslavia") ~ "Serbia",
      country %in% c("Czechoslovakia") ~ "Czech Republic",
      country %in% c("Dutch West Indies") ~ "Indonesia",
      country %in% c("Zaire") ~ "Democratic Republic of the Congo",
      TRUE ~ country
    )
  ) %>%
  group_by(country) %>%
  summarise(total_points = sum(total_points))
```


### Part 2: Visualising `total_points` on a heatmap

We now visualise the total points obtained on a heatmap by using `map_data("world")` to get the world coordinates. We renamed some countries to match those in the `wcmatches_tabulated` dataset. For example, the United Kingdom consisting of Scotland, Great Britain, Isle of Wight, Wales and Northern Ireland should be separated into their subregions.
Next, we do a full join on the `world_map` dataset with the `wcmatches_tabulated` dataset, as we want to include countries that never participated in the World Cup in our map. All countries in `wcmatches_tabulated` exist in the `region` column of the `world_map` dataset. Lastly, we use `ggplot` to generate a heatmap showcasing the total points each country obtained from World Cup matches over the years. Countries that never participated in the World Cup have a score of `NA` in the `top_countries_joined` dataset and are coloured white in the heatmap.

```{r Heatmap}
world_map <- map_data("world") %>%
             mutate(region = case_when(
               region == "USA" ~ "United States",
               region == "China" ~ "China PR",
               region == "Ireland" ~ "Republic of Ireland",
               subregion == "Scotland" ~ "Scotland",
               subregion == "Great Britain" ~ "England",
               subregion == "Isle of Wight" ~ "England",
               subregion == "Wales" ~ "Wales",
               subregion == "Northern Ireland" ~ "Northern Ireland",
               .default = region)) %>%
             select(-subregion)

top_countries_joined <- wcmatches_tabulated %>%
                        full_join(world_map, by = c("country" = "region"))

ggplot(top_countries_joined, aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_points)) +
  labs(title = "Global Distribution of Total Points obtained across World Cups (1930-2018)") +
  scale_fill_gradientn(name = "Total Points",
                       colors = c("#ffffb2", "#fecc5c", "#fd8d3c", "#f03b20", "#bd0026"),
                       na.value = "white") +
  borders(colour = "black", size = 0.1) +
  theme_minimal() +
  theme(legend.position = "bottom", axis.title = element_blank(), axis.text = element_blank(),
        panel.grid = element_blank(), plot.title = element_text(hjust = 0.5)) +
  ylim(-60, 90)
```

## Visualisation 2: Scatter Plot

Host country performance: Avg number of wins when they are not the host vs when they are the host 
```{r Scatter}
# Group stage matches
wc_groupstage_matches <- wcmatches_tidy %>%
  filter(stage_status == 'Group Stage', country == home_team) %>%
  group_by(year, country) %>%
  summarise(group_stage_matches_played = n())

wc_groupstage_matches

# Non-group stage, non-1950
wc_elimstage_matches <- wcmatches_tidy %>%
  filter(year != '1950', stage_status != 'Group Stage') %>%
  group_by(year, country) %>%
  summarise(elim_matches_played = n_distinct(stage_status))

# Non-group stage, 1950
wc_elimstage_matches1 <- wcmatches_tidy %>%
  filter(year == '1950', stage_status != 'Group Stage', country == home_team) %>%
  group_by(year, country) %>%
  summarise(elim_matches_played = n()) %>%
  bind_rows(wc_elimstage_matches)

# Merge group stage and non-group stage
wc_total_matches <- wc_groupstage_matches %>%
  full_join(wc_elimstage_matches1, by = c('year', 'country')) %>%
  replace_na(list(group_stage_matches_played = 0)) %>%
  mutate(total_possible_matches = group_stage_matches_played + elim_matches_played) %>%
  select(country, total_possible_matches) %>%
  group_by(country) %>%
  summarise(total_possible = sum(total_possible_matches))

#proportion
wcmatches_tidy1 <- wcmatches_tidy %>%
  filter(country == home_team, win_outcome == "Home") %>%
  select(year, country, stage_status, home_team, win_outcome) %>%
  group_by(country) %>%
  summarise(matches_won_hometeam = n()) %>%
  left_join(wc_total_matches, by = 'country') %>%
  group_by(country) %>%
  summarise(proportion_win = round(matches_won_hometeam * 100 / total_possible, 2)) %>%
  replace_na(list(proportion_win = 0))
```


## Visualisation 3: Line Plot
Firstly, we want to find the proportion of goals that a host country has scored during their run. (Include why we want to visualize this) 

First, we filter for the rows of the `wcmatches_tidy` dataset where the home team is the host country. We do not consider the away team as the host country is always observed in the home team column and not the away team column of the dataset. We group the observations by year before calculating the number of goals scored by the host country for each year. Next, for the `worldcups_tidy` dataset, we similarly group each observation by year and calculate the number of goals_scored for each year (for the host country) for all matches. Next, we rename the host_country column of the dataset to country for easier joining of datasets
Afterwards, we join the `viz_3_wcmatches` and `viz_3_worldcups` dataset together by year and afterwards, calculate the proportion of goals that the host countries have scored during their runs. Lastly, we create a line plot for the proportion of goals that the host countries have scored during their runs for the respective years using geom_line. As mentioned above, the years 1942 and 1946 are not included and we simply connect the 1938 proportion and the 1950 proportion together using a straight line. 

```{r Line Plot 3a, warning = FALSE, message = FALSE }
viz_3_wcmatches <- wcmatches_tidy %>% 
  filter(home_team == country) %>%
  select(year, home_score) %>%
  group_by(year) %>%
  summarize(total_goals_scored = sum(home_score))

viz_3_worldcups <- worldcups_tidy %>%
  rename(country = host_country) %>%
  group_by(year, country) %>% 
  summarize(goals_scored = mean(goals_scored)) %>% 
  select(year, country, goals_scored)

viz_3_data <- viz_3_wcmatches %>%
  left_join(viz_3_worldcups, by = "year") %>%
  mutate(goal_proportion = (total_goals_scored / goals_scored) * 100) %>%
  select(year, country, goal_proportion)

ggplot(data = viz_3_data, aes(x = year, y = goal_proportion)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2.5) +
  scale_x_continuous(breaks = seq(1930, 2018, 8)) +
  scale_y_continuous(labels = scales::label_number(suffix = "%")) +
  labs(title = "Proportion of Goals scored by Host Countries (1930-2018)",
       subtitle = "Goals scored by host country as a percentage of total goals scored",
       x = "Year", y = "Proportion of Goals Scored") +
  theme(plot.title = element_text(hjust = 0.5), 
        plot.subtitle = element_text(hjust = 0.5))
```

# Discussion
From the guidelines (1-2 paragraphs): Describe the primary insights you aim to convey through your visualizations. Explore and explain why the data appears the way it does.

Something about host country's performance


# References
- R for Data Science Community. (2022, November 29). TidyTuesday Week 48, 2022. GitHub. https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-11-29
- USA ’94: A World Cup of firsts. (2016, May 4). FIFA Museum. https://www.fifamuseum.com/en/blog-stories/blog/usa-94-a-15th-world-cup-full-of-firsts-2610677/

