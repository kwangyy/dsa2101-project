---
title: "DSA2101 Group Project"
author: "World Cup Finals Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The FIFA World Cup Dataset covers every single World Cup match played in its history from Uruguay in 1930 to Russia in 2018. The dataset consists of two `csv` files: `wcmatches.csv` and `worldcups.csv`.

1. The `wcmatches.csv` file contains every football match played in the World Cup, with some columns like which year, which team claimed victory, and what the win condition was.

2. The `worldcups.csv` file contains the winners and has some dataset features like winners, games, goals_scored and more.

We load the libraries to be used here:
```{r, warning = FALSE}
library(readr)
library(tidyverse)
library(stringr)
library(ggplot2)
library(forcats)
library(maps)
library(ggthemes)
library(viridis)
```

# Data cleaning and summary

Firstly, we prepare the two datasets using the `readr` package.

```{r Reading Data}
library("tidytuesdayR")
tuesdata <- tt_load(2022, week = 48)

wcmatches <- tuesdata$wcmatches
worldcups <- tuesdata$worldcups
```

After that, we did some cleaning with the two datasets. 

In data preparation for the `worldcups` dataset, we restructured it by pivoting the data longer, condensing the `winner` columns to `fourth` columns to create a cleaner `position_status` column. We also standardised `USA` to `United States`, and introduced a new `continent` feature for future visualization, splitting into North and South America (`americas`), Europe (`europe`) and the rest of the world (`others`).

```{r Data Cleaning 1}
americas <- c("Uruguay", "Brazil", "Chile", "Mexico", "Argentina", "United States")

europe <- c("Italy", "France", "Switzerland", "Sweden", "England", "Germany", "Spain", "West Germany", "Netherlands", "Austria", "Belgium", "Croatia", "Czechoslovakia", "Hungary", "Poland", "Portugal", "Yugoslavia", "Bulgaria", "Soviet Union", "Turkey", "Russia")

others <- c("South Africa", "Japan", "South Korea", "Japan, South Korea")

worldcups_tidy <- worldcups %>%
                  pivot_longer(winner:fourth, names_to = "position_status", values_to = "country_name") %>%
                  rename(host_country = host) %>%
                  mutate(host_country = ifelse(host_country == "USA", "United States", host_country), 
                         country_name = ifelse(country_name == "USA", "United States", country_name)) %>% mutate(host_continent = case_when(
                         host_country %in% americas ~ "Americas", 
                         host_country %in% europe ~ "Europe",
                         host_country %in%  others ~ "Rest Of World"), 
                         country_continent = case_when(
                         country_name %in% americas ~ "Americas", 
                         country_name %in% europe ~ "Europe",
                         country_name %in%  others ~ "Rest Of World")) 
```

For the `wcmatches` dataset, columns were renamed, clarifying `stage_status` from `stage` and `win_outcome` from `outcome`. We refined the `stage_status` further, converting `Group` to `Group Stage` and `Final Round` to `Finals` for clarity. Redundant date information was removed, and the `win_outcome` column was expanded for clear representation of `H` (Home Win), `D` (Draw), and `A` (Away Win). We calculated the score difference, filled the `win_conditions` column with `Nil`, and extracted two features, `after_extra_time` and `penalties`.

```{r Data Cleaning 2}
wcmatches_tidy <- wcmatches %>%
                  rename(stage_status = stage, win_outcome = outcome) %>%
                  mutate(stage_status = ifelse(str_detect(stage_status, "Group"), "Group Stage", stage_status), 
                         stage_status = ifelse(stage_status == "Final Round", "Finals", stage_status)) %>%
                  select(-date) %>%
                  mutate(win_outcome = case_when(
                         home_score == away_score ~ "Draw",
                         win_outcome == "H" ~ "Home",
                         win_outcome == "D" ~ "Draw",
                         win_outcome == "A" ~ "Away")) %>%
                  mutate(score_difference = abs(home_score - away_score), 
                         win_conditions = replace_na(win_conditions, "Nil"),
                         after_extra_time = ifelse(str_detect(win_conditions, "AET"), 1, 0), 
                         penalties = ifelse(str_detect(win_conditions, "penalties"), 1, 0)) 
```

These are all in preparation to answer the question: **What factors affect the performance of countries in the World Cup?**


# Visualisations

## Visualisation 1: Heat Map

**Create a heat map showcasing the total points across all world cups for every country**

### Part 1: Preparing the Data

As our objecive is to show the total points obtained across all world cup matches for each country, we should first tabulate the all-time total points obtained for each country. As per FIFA's convention, for each match, we award 3 points to the winning team, 0 points to the losing team and 1 point to both teams if the match ends up in a draw.

- Group Stage matches before 1994's World Cup awarded 2 points for a win instead of 3, but for simplicity and standardisation, we will award 3 points for a win regardless of the year.

- For knockout stage matches where one team wins in extra time, we award 3 points to the winning team and 0 points to the losing team.

- For knockout stage matches that end up in penalty shootouts, we award 1 point to both teams as we consider it a draw. The outcome of the penalty shootout does not affect the points.

For our dataset, we considered the following cases in point allocation:

- Case 1: If Home Score > Away Score, Home Team given 3 points, Away Team given 0 points. 
  
- Case 2: If Away Score > Home Score, Away Team given 3 points, Home Team given 0 points.
  
- Case 3: If Home Score = Away Score, match is a draw, 1 point will be allocated to both teams. 
  
Note: `after_extra_time` does not affect the victory/loss of the teams. Matches that require penalties are considered draw.

Firstly, we ensure that all the rows of the `wcmatches_tidy` dataset where penalties are required are set to Draw in the `win_outcome` column of the dataset. Afterwards, select the relevant columns: `home_team`, `away_team` and `win_outcome` to tidy the dataset further. This is stored in a new dataset called `wcmatches_updated`.

```{r Heatmap 1a}
wcmatches_updated <- wcmatches_tidy %>%
                     mutate(win_outcome = ifelse(penalties == 1, "Draw", win_outcome)) %>%
                     select(home_team, away_team, win_outcome)
```

Next, we filter the `wcmatches_updated` dataset for observations that either the home team or the away team wins. The teams that win the matches will be kept. Count the number of times each team is present in the dataset and subsequently, multiply the count of each team by 3 to get the win points. We store this in a dataset called `wcmatches_wins`. We can ignore the losing teams, as losing a match will not award any points.
```{r Heatmap 1b}
wcmatches_wins <- wcmatches_updated %>%
                  filter(win_outcome %in% c("Home", "Away")) %>%
                  mutate(country = ifelse(win_outcome == "Home", home_team, away_team)) %>%
                  select(country) %>%
                  group_by(country) %>%
                  summarise(win_points = 3 * n())
```

We do the same for matches that end up in a draw, by filtering `wcmatches_updated` for observations where the matches have a draw result. Both the home team and the away team will be kept. We then combine the home and away teams in a single column and count the number of times each team is present in the dataset. Points obtained from matches that end up in draws is equal to the count, since draws give 1 point to both teams. We store this in a dataset called `wcmatches_draws`.
```{r Heatmap 1c}
wcmatches_draws <- wcmatches_updated %>%
                   filter(win_outcome == "Draw") %>%
                   pivot_longer(home_team:away_team) %>%
                   rename(country = value) %>%
                   select(country) %>%
                   group_by(country) %>%
                   summarise(draw_points = n())
```

Afterwards, we do a full join of `wcmatches_wins` and `wcmatches_draws` and ensure that all teams are contained in the merged dataset. We use `full_join` because we do not want to omit countries that only ever had matches that ended up in a draw, or countries that only ever had matches that ended up in a win/loss.

Certain entries in the merged dataset contain NA values as some countries are not found in either `wcmatches_draws` or `wcmatches_wins`. The NA values should be replaced by 0. Compute the total points for each country by summing the draw points and win points.

Certain teams such as Soviet Union, Yugoslavia and Czechoslovakia should be renamed to their current-day regions in order to merge with the `world_coordinates` dataset. Store it in a new dataset called `wcmatches_tabulated`.

```{r Heatmap 1d}
wcmatches_tabulated <- wcmatches_wins %>%
                       full_join(wcmatches_draws, by = "country") %>%
                       mutate(win_points = replace_na(win_points, 0),
                              draw_points = replace_na(draw_points, 0),
                              total_points = win_points + draw_points) %>% 
                       select(country, total_points) %>%
                       mutate(country = case_when(
                         country == "West Germany" ~ "Germany",
                         country == "East Germany" ~ "Germany",
                         country == "Soviet Union" ~ "Russia",
                         country == "Yugoslavia" ~ "Serbia",
                         country == "FR Yugoslavia" ~ "Serbia",
                         country == "Czechoslovakia" ~ "Czech Republic",
                         .default = country)) %>%
                       group_by(country) %>%
                       summarise(total_points = sum(total_points))
```

## Part 2: Visualising `total_points` on a heat map

First, we obtain information on the coordinates of the countries by using the `map_data("world")`.

We noticed that certain subregions in the dataset are not properly separated into the respective regions (eg. Scotland, Great Britain, Isle of Wight and Wales are all under UK in the region column of the dataset). However, these countries should be differentiated by region, as per FIFA's convention.

```{r Heatmap 2a}
world_coordinates = map_data("world") %>%
                    mutate(region = case_when(
                           region == "USA" ~ "United States",
                           subregion == "Scotland" ~ "Scotland",
                           subregion == "Great Britain" ~ "England",
                           subregion == "Isle of Wight" ~ "England",
                           subregion == "Wales" ~ "Wales",
                           subregion == "Northern Ireland" ~ "Northern Ireland",
                           .default = region)) %>%
                    select(-subregion) %>%
                    filter(region != "Antarctica")
```

Next, join the `world_coordinates` dataset with the `wcmatches_tabulated` dataset by the name of the region. All the country names in the `wcmatches_tabulated` exist in the region column of the `world_coordinates` dataset.

```{r Heatmap 2b}
top_countries_joined = wcmatches_tabulated %>%
                       left_join(world_coordinates, by = c("country" = "region"))
```

Lastly, use ggplot to generate the heatmap that showcase the total number of points various countries earned from the world cup matches over the years. Countries that are not involved in the world cup have a score of NA in the `top_countries_joined` dataset and hence, encoded as a grey shade in the heatmap. The viridis package is being used for users who are color-blind to observe the colours distributed across the heatmap well.

```{r Heatmap 2c}
ggplot(data = top_countries_joined, mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_points)) +
  labs(title = "Global Distribution of Total Points obtained across World Cups (1930-2018)") + 
  scale_fill_viridis(name = "Total Points", limits = c(0, 250)) + 
  theme(axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "white")) +
  borders(database = "world", regions = ".", fill = NA, colour = "black", size = 0.1) + 
  theme_map() + 
  theme_minimal() + 
  theme(legend.position = "bottom", axis.title = element_blank(),
        axis.text = element_blank(), axis.ticks = element_blank()) + 
  ylim(-60, 100)
```

## Visualisation 2: Scatter Plot

Host country performance
```{r Scatter}

```


## Visualisation 3: Line Plot
```{r Line Plot}


```


# DO NOT DELETE THIS
1. find country with best overall performance --> hypothesize with the next few questions
2. line plot
3. scatterplot



# Discussion



# References
- R for Data Science Community. (2022, November 29). TidyTuesday Week 48, 2022. GitHub. https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-11-29





