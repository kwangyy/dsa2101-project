---
title: "DSA2101 Group Project"
author: "World Cup Finals Group"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

The FIFA World Cup Dataset covers every single World Cup match played in its history from Uruguay in 1930 to Russia in 2018. The dataset consists of two `csv` files: `wcmatches.csv` and `worldcups.csv`.

1. The `wcmatches.csv` file contains every football match played in the World Cup, with some columns like which year, which team claimed victory, and what the win condition was.

2. The `worldcups.csv` file contains the winners and has some dataset features like winners, games, goals_scored and more.

We load the libraries to be used here:
```{r, warning = FALSE}
library(readr)
library(tidyverse)
library(stringr)
library(ggplot2)
library(forcats)
library(maps)
library(ggthemes)
library(viridis)
```

# Data cleaning and summary

Firstly, we prepare the two datasets using the `readr` package.

```{r Reading Data}
library("tidytuesdayR")
tuesdata <- tt_load(2022, week = 48)

wcmatches <- tuesdata$wcmatches
worldcups <- tuesdata$worldcups
```

After that, we did some cleaning with the two datasets. 

In data preparation for the `worldcups` dataset, we restructured it by pivoting the data longer, condensing the `winner` columns to `fourth` columns to create a cleaner `position_status` column. We also standardised `USA` to `United States`, and introduced a new `continent` feature for future visualization, splitting into North and South America (`americas`), Europe (`europe`) and the rest of the world (`others`).

```{r Data Cleaning 1}
americas <- c("Uruguay", "Brazil", "Chile", "Mexico", "Argentina", "United States")

europe <- c("Italy", "France", "Switzerland", "Sweden", "England", "Germany", "Spain", "West Germany", "Netherlands", "Austria", "Belgium", "Croatia", "Czechoslovakia", "Hungary", "Poland", "Portugal", "Yugoslavia", "Bulgaria", "Soviet Union", "Turkey", "Russia")

others <- c("South Africa", "Japan", "South Korea", "Japan, South Korea")

worldcups_tidy <- worldcups %>%
                  pivot_longer(winner:fourth, names_to = "position_status", values_to = "country_name") %>%
                  rename(host_country = host) %>%
                  mutate(host_country = ifelse(host_country == "USA", "United States", host_country), 
                         country_name = ifelse(country_name == "USA", "United States", country_name)) %>% mutate(host_continent = case_when(
                         host_country %in% americas ~ "Americas", 
                         host_country %in% europe ~ "Europe",
                         host_country %in%  others ~ "Rest Of World"), 
                         country_continent = case_when(
                         country_name %in% americas ~ "Americas", 
                         country_name %in% europe ~ "Europe",
                         country_name %in%  others ~ "Rest Of World")) 
```

For the `wcmatches` dataset, columns were renamed, clarifying `stage_status` from `stage` and `win_outcome` from `outcome`. We refined the `stage_status` further, converting `Group` to `Group Stage` and `Final Round` to `Finals` for clarity. Redundant date information was removed, and the `win_outcome` column was expanded for clear representation of `H` (Home Win), `D` (Draw), and `A` (Away Win). We calculated the score difference, filled the `win_conditions` column with `Nil`, and extracted two features, `after_extra_time` and `penalties`.

```{r Data Cleaning 2}
wcmatches_tidy <- wcmatches %>%
                  rename(stage_status = stage, win_outcome = outcome) %>%
                  mutate(stage_status = ifelse(str_detect(stage_status, "Group"), "Group Stage", stage_status), 
                         stage_status = ifelse(stage_status == "Final Round", "Finals", stage_status)) %>%
                  select(-date) %>%
                  mutate(win_outcome = case_when(
                         home_score == away_score ~ "Draw",
                         win_outcome == "H" ~ "Home",
                         win_outcome == "D" ~ "Draw",
                         win_outcome == "A" ~ "Away")) %>%
                  mutate(score_difference = abs(home_score - away_score), 
                         win_conditions = replace_na(win_conditions, "Nil"),
                         after_extra_time = ifelse(str_detect(win_conditions, "AET"), 1, 0), 
                         penalties = ifelse(str_detect(win_conditions, "penalties"), 1, 0)) 
```

These are all in preparation to answer the question: **What factors affect the performance of countries in the World Cup?**


# Visualisations

## Visualisation 1: Heat Map

**Create a heat map showcasing the total points across all world cups for every country**

First, the information of the coordinates of the countries in terms of longitude and latitude are needed to plot the heatmap. The coordinates can be obtained by using the `map_data("world")` command. Certain subregions in the dataset are not properly separated into the respective regions (eg. Scotland, Great Britain, Isle of Wight and Wales are all under UK in the region column of the dataset). However, these countries should be differentiated by region.  

```{r Heat Map 1}
world_coordinates = map_data("world") %>%
                    mutate(region = case_when(
                           region == "USA" ~ "United States",
                           subregion == "Scotland" ~ "Scotland",
                           subregion == "Great Britain" ~ "England",
                           subregion == "Isle of Wight" ~ "England",
                           subregion == "Wales" ~ "Wales",
                           subregion == "Northern Ireland" ~ "Northern Ireland",
                           .default = region)) %>%
                    select(-subregion)

```


Join `wcmatches_wins` and `wcmatches_draws` and ensure that all teams are contained in the merged dataset. Certain entries in the merged dataset contain NA values as some teams are not found in either `wcmatches_draws` or `wcmatches_wins`. The NA values should be replaced by 0. Compute the total points for each team by summing the draw points and win points. Certain teams such as Yugoslavia and Czechoslovakia should be renamed to their respective regions in order to merge with the `world_coordinates` dataset. Store it in a new dataset called `wcmatches_tabulated_two`.

```{r Heat Map 2}
wcmatches_tabulated_two <- wcmatches_wins %>%
                           full_join(wcmatches_draws, by = "country") %>%
                           mutate(win_points = replace_na(win_points, 0),
                                  draw_points = replace_na(draw_points, 0),
                                  total_points = win_points + draw_points) %>% 
                           select(country, total_points) %>% 
                           mutate(country = case_when(
                                  country == "West Germany" ~ "Germany",
                                  country == "East Germany" ~ "Germany",
                                  country == "Soviet Union" ~ "Russia",
                                  country == "Yugoslavia" ~ "Serbia",
                                  country == "FR Yugoslavia" ~ "Serbia",
                                  country == "Czechoslovakia" ~ "Czech Republic",
                                  .default = country)) %>%
                           group_by(country) %>%
                           summarise(total_points = sum(total_points))
```

Next, join the `world_coordinates` dataset with the `wcmatches_tabulated_two` dataset by the name of the region. All the country names in the `wcmatches_tabulated_two` exist in the region column of the `world_coordinates` dataset.

```{r Heat Map 3}
top_countries_joined = world_coordinates %>%
                       left_join(wcmatches_tabulated_two, by = c("region" = "country"))
```

Lastly, use ggplot to generate the heatmap that showcase the total number of points various countries earned from the world cup matches over the years. Countries that are not involved in the world cup have a score of NA in the `top_countries_joined` dataset and hence, encoded as a grey shade in the heatmap. The viridis package is being used for users who are color-blind to observe the colours distributed across the heatmap well.

```{r Heat Map 4}
ggplot(data = top_countries_joined, mapping = aes(x = long, y = lat, group = group)) +
  geom_polygon(aes(fill = total_points)) +
  labs(title = "Global Distribution of Total Points obtained across World Cups") + 
  scale_fill_viridis(limits = c(0, 250)) + 
  theme(axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        panel.background = element_rect(fill = "white")) +
  borders(database = "world", regions = ".", fill = NA, colour = "black", size = 0.1) + 
  theme_map() + 
  theme_minimal() + 
  theme(legend.position = "bottom", axis.title = element_blank(), axis.text = element_blank(), axis.ticks = element_blank()) + 
  ylim(-60, 100)
  

```

## Visualisation 2: Scatter Plot

Host country performance
```{r Scatter}

```


## Visualisation 3: Line Plot
```{r Line Plot}


```


# DO NOT DELETE THIS
1. find country with best overall performance --> hypothesize with the next few questions
2. line plot
3. scatterplot



# Discussion



# References
- R for Data Science Community. (2022, November 29). TidyTuesday Week 48, 2022. GitHub. https://github.com/rfordatascience/tidytuesday/blob/master/data/2022/2022-11-29





